doctype html
html
    head
        meta(name="viewport" content="width=device-width,initial-scale=1.0")
        title Admin - Thumbnail Management
        style 
            include ../../public/styles.css
    body
        div.header.hero.is-dark.is-small
            div.hero-head
                div.container.has-text-centered-mobile.block
                    h1.title.is-2 Admin - Thumbnail Management
                    p.subtitle Browse and manage video thumbnails
        div.container
            div.section
                h2.title.is-4 Video Management
                
                div.box.mb-4
                    h3.subtitle.is-5 Filters
                    div.field.is-grouped.is-grouped-multiline
                        div.control
                            label.label.is-small Category
                            div.select.is-small
                                select#filterCategory(onchange="applyFilters()")
                                    option(value="") All Categories
                                    each category in Categories
                                        option #{category.Name}
                        div.control
                            label.label.is-small Gallery
                            div.select.is-small
                                select#filterGallery(onchange="applyFilters()")
                                    option(value="") All Galleries
                        div.control
                            label.label.is-small Status
                            div.select.is-small
                                select#filterStatus(onchange="applyFilters()")
                                    option(value="") All
                                    option(value="has") Has Thumbnail
                                    option(value="missing") Missing Thumbnail
                        div.control
                            label.label.is-small Search
                            input.input.is-small#filterSearch(type="text" placeholder="Search videos..." oninput="applyFilters()")
                
                div.box.mb-4
                    h3.subtitle.is-5 Bulk Operations
                    div.field.is-grouped.is-grouped-multiline
                        div.control
                            label.label.is-small Thumbnail Time (ms)
                            input.input.is-small#bulkTimeMs(type="number" value="1000" min="0" step="100")
                        div.control
                            label.label.is-small(for="parallelOps") Parallel Operations
                            input.input.is-small#parallelOps(type="number" value="3" min="1" max="10" step="1" title="Number of operations to run in parallel")
                        div.control
                            label.label.is-small &nbsp;
                            button.button.is-info.is-small#btnGenerate(onclick="generateSelectedThumbnails()" disabled)
                                span.icon
                                    i ðŸ“·
                                span Generate Selected
                        div.control
                            label.label.is-small &nbsp;
                            button.button.is-danger.is-small#btnClear(onclick="clearSelectedThumbnails()" disabled)
                                span.icon
                                    i ðŸ—‘ï¸
                                span Clear Selected
                        div.control
                            label.label.is-small &nbsp;
                            span.tag.is-info#selectedCount 0 selected
                
                div.table-container
                    table.table.is-fullwidth.is-striped.is-hoverable#videoTable
                        thead
                            tr
                                th
                                    input#selectAll(type="checkbox" onchange="toggleSelectAll()")
                                th Thumbnail
                                th Video
                                th 
                                    a(href="#" onclick="sortBy('gallery'); return false;") Gallery â†•
                                th 
                                    a(href="#" onclick="sortBy('category'); return false;") Category â†•
                                th Status
                                th Actions
                        tbody
                            each category in Categories
                                each gallery in category.Galleries
                                    each video in gallery.Videos
                                        tr.video-row
                                            td(style="display:none;")
                                                input.row-category(type="hidden" value=category.Name)
                                                input.row-gallery(type="hidden" value=gallery.Name)
                                                input.row-video(type="hidden" value=video.Name)
                                            td
                                                input.video-checkbox(type="checkbox" onchange="updateSelectedCount()")
                                            td
                                                if video.Thumbnail
                                                    div.thumbnail-preview
                                                        img(src=video.Thumbnail alt=video.Name)
                                                else
                                                    div.thumbnail-preview.thumbnail-missing
                                                        span.is-size-3 âŒ
                                            td
                                                strong #{video.Name}
                                                input.video-path(type="hidden" value=video.VideoPath)
                                                input.thumbnail-path(type="hidden" value=video.ThumbnailPath)
                                            td #{gallery.Name}
                                            td #{category.Name}
                                            td
                                                if video.Thumbnail
                                                    span.tag.is-success.is-small Has Thumbnail
                                                else
                                                    span.tag.is-warning.is-small Missing
                                            td
                                                div.field.has-addons
                                                    div.control
                                                        input.input.is-small.time-input(type="number" value="1000" min="0" step="100" style="width:80px")
                                                    div.control
                                                        button.button.is-info.is-small.btn-generate(title="Generate")
                                                            span ðŸ“·
                                                    if video.Thumbnail
                                                        div.control
                                                            button.button.is-danger.is-small.btn-clear(title="Clear")
                                                                span ðŸ—‘ï¸
                                                div.notification.is-hidden.mt-2.is-small.status-msg

        script
            | const secretKey = '#{SecretKey}';
            | let sortOrder = {gallery: 'asc', category: 'asc'};
            | 
            | function saveFilterState() {
            |     const filterState = {
            |         category: document.getElementById('filterCategory').value,
            |         gallery: document.getElementById('filterGallery').value,
            |         status: document.getElementById('filterStatus').value,
            |         search: document.getElementById('filterSearch').value,
            |         sortOrder: sortOrder
            |     };
            |     localStorage.setItem('adminFilterState', JSON.stringify(filterState));
            | }
            | 
            | function restoreFilterState() {
            |     const savedState = localStorage.getItem('adminFilterState');
            |     if (savedState) {
            |         try {
            |             const filterState = JSON.parse(savedState);
            |             document.getElementById('filterCategory').value = filterState.category || '';
            |             document.getElementById('filterStatus').value = filterState.status || '';
            |             document.getElementById('filterSearch').value = filterState.search || '';
            |             if (filterState.sortOrder) {
            |                 sortOrder = filterState.sortOrder;
            |             }
            |             
            |             /* Restore gallery filter after populating options */
            |             populateGalleryFilter();
            |             if (filterState.gallery) {
            |                 document.getElementById('filterGallery').value = filterState.gallery;
            |             }
            |             
            |             applyFilters();
            |         } catch (e) {
            |             console.error('Error restoring filter state:', e);
            |         }
            |     }
            | }
            | 
            | document.addEventListener('DOMContentLoaded', function() {
            |     sortBy('category');
            |     restoreFilterState();
            | });
            | 
            | document.getElementById('videoTable').addEventListener('click', function(e) {
            |     const generateBtn = e.target.closest('.btn-generate');
            |     const clearBtn = e.target.closest('.btn-clear');
            |     
            |     if (generateBtn) {
            |         const row = generateBtn.closest('tr');
            |         const videoPath = row.querySelector('.video-path').value;
            |         const timeInput = row.querySelector('.time-input');
            |         const timeMs = timeInput.value;
            |         generateThumbnail(row, videoPath, timeMs);
            |     } else if (clearBtn) {
            |         const row = clearBtn.closest('tr');
            |         const thumbnailPath = row.querySelector('.thumbnail-path').value;
            |         clearThumbnail(row, thumbnailPath);
            |     }
            | });
            | 
            | function populateGalleryFilter() {
            |     const gallerySelect = document.getElementById('filterGallery');
            |     const galleries = new Set();
            |     const rows = document.querySelectorAll('#videoTable tbody tr');
            |     rows.forEach(row => {
            |         const galleryInput = row.querySelector('.row-gallery');
            |         if (galleryInput) galleries.add(galleryInput.value);
            |     });
            |     galleries.forEach(gallery => {
            |         const option = document.createElement('option');
            |         option.value = gallery;
            |         option.textContent = gallery;
            |         gallerySelect.appendChild(option);
            |     });
            | }
            | 
            | document.getElementById('filterCategory').addEventListener('change', function() {
            |     const category = this.value;
            |     const gallerySelect = document.getElementById('filterGallery');
            |     gallerySelect.innerHTML = '<option value="">All Galleries</option>';
            |     
            |     if (category) {
            |         const galleries = new Set();
            |         const rows = document.querySelectorAll('#videoTable tbody tr');
            |         rows.forEach(row => {
            |             const catInput = row.querySelector('.row-category');
            |             const galInput = row.querySelector('.row-gallery');
            |             if (catInput && catInput.value === category && galInput) {
            |                 galleries.add(galInput.value);
            |             }
            |         });
            |         galleries.forEach(gallery => {
            |             const option = document.createElement('option');
            |             option.value = gallery;
            |             option.textContent = gallery;
            |             gallerySelect.appendChild(option);
            |         });
            |     } else {
            |         populateGalleryFilter();
            |     }
            |     applyFilters();
            | });
            | 
            | function sortBy(column) {
            |     const tbody = document.querySelector('#videoTable tbody');
            |     const rows = Array.from(tbody.querySelectorAll('tr'));
            |     
            |     sortOrder[column] = sortOrder[column] === 'asc' ? 'desc' : 'asc';
            |     const order = sortOrder[column];
            |     
            |     rows.sort((a, b) => {
            |         const aInput = a.querySelector('.row-' + column);
            |         const bInput = b.querySelector('.row-' + column);
            |         let aVal = aInput ? aInput.value : '';
            |         let bVal = bInput ? bInput.value : '';
            |         
            |         const comparison = aVal.localeCompare(bVal);
            |         return order === 'asc' ? comparison : -comparison;
            |     });
            |     
            |     rows.forEach(row => tbody.appendChild(row));
            |     saveFilterState();
            | }
            | 
            | function applyFilters() {
            |     const category = document.getElementById('filterCategory').value;
            |     const gallery = document.getElementById('filterGallery').value;
            |     const status = document.getElementById('filterStatus').value;
            |     const search = document.getElementById('filterSearch').value.toLowerCase();
            |     
            |     const rows = document.querySelectorAll('#videoTable tbody tr');
            |     rows.forEach(row => {
            |         let show = true;
            |         const thumbnail = row.querySelector('img');
            |         const hasThumbnail = thumbnail !== null;
            |         
            |         const videoInput = row.querySelector('.row-video');
            |         const galleryInput = row.querySelector('.row-gallery');
            |         const categoryInput = row.querySelector('.row-category');
            |         
            |         const videoName = videoInput ? videoInput.value.toLowerCase() : '';
            |         const galleryName = galleryInput ? galleryInput.value : '';
            |         const categoryName = categoryInput ? categoryInput.value : '';
            |         
            |         if (category && categoryName !== category) show = false;
            |         if (gallery && galleryName !== gallery) show = false;
            |         if (status === 'has' && !hasThumbnail) show = false;
            |         if (status === 'missing' && hasThumbnail) show = false;
            |         if (search && !videoName.includes(search)) show = false;
            |         
            |         row.style.display = show ? '' : 'none';
            |     });
            |     saveFilterState();
            | }
            | 
            | function toggleSelectAll() {
            |     const selectAll = document.getElementById('selectAll');
            |     const checkboxes = document.querySelectorAll('.video-checkbox');
            |     checkboxes.forEach(cb => {
            |         const row = cb.closest('tr');
            |         if (row.style.display !== 'none') {
            |             cb.checked = selectAll.checked;
            |         }
            |     });
            |     updateSelectedCount();
            | }
            | 
            | function updateSelectedCount() {
            |     const checked = document.querySelectorAll('.video-checkbox:checked');
            |     const count = checked.length;
            |     document.getElementById('selectedCount').textContent = count + ' selected';
            |     document.getElementById('btnGenerate').disabled = count === 0;
            |     document.getElementById('btnClear').disabled = count === 0;
            | }
            | 
            | async function generateSelectedThumbnails() {
            |     const timeMs = document.getElementById('bulkTimeMs').value;
            |     const parallelOps = parseInt(document.getElementById('parallelOps').value) || 3;
            |     const checked = Array.from(document.querySelectorAll('.video-checkbox:checked'));
            |     
            |     if (checked.length === 0) return;
            |     
            |     if (!confirm('Generate thumbnails for ' + checked.length + ' video(s)?')) return;
            |     
            |     let completed = 0;
            |     const total = checked.length;
            |     
            |     /* Process in batches with limited parallelism */
            |     for (let i = 0; i < checked.length; i += parallelOps) {
            |         const batch = checked.slice(i, i + parallelOps);
            |         await Promise.all(batch.map(cb => {
            |             return new Promise((resolve) => {
            |                 try {
            |                     const row = cb.closest('tr');
            |                     const videoPath = row.querySelector('.video-path').value;
            |                     generateThumbnail(row, videoPath, timeMs, function() {
            |                         completed++;
            |                         if (completed === total) {
            |                             setTimeout(function() { location.reload(); }, 2000);
            |                         }
            |                         resolve();
            |                     });
            |                 } catch (error) {
            |                     console.error('Error processing thumbnail:', error);
            |                     resolve();
            |                 }
            |             });
            |         }));
            |     }
            | }
            | 
            | async function clearSelectedThumbnails() {
            |     const parallelOps = parseInt(document.getElementById('parallelOps').value) || 3;
            |     const checked = Array.from(document.querySelectorAll('.video-checkbox:checked'));
            |     
            |     if (checked.length === 0) return;
            |     
            |     if (!confirm('Clear thumbnails for ' + checked.length + ' video(s)? This cannot be undone.')) return;
            |     
            |     let completed = 0;
            |     const total = checked.length;
            |     
            |     /* Process in batches with limited parallelism */
            |     for (let i = 0; i < checked.length; i += parallelOps) {
            |         const batch = checked.slice(i, i + parallelOps);
            |         await Promise.all(batch.map(cb => {
            |             return new Promise((resolve) => {
            |                 try {
            |                     const row = cb.closest('tr');
            |                     const thumbnailPath = row.querySelector('.thumbnail-path').value;
            |                     if (thumbnailPath) {
            |                         clearThumbnail(row, thumbnailPath, function() {
            |                             completed++;
            |                             if (completed === total) {
            |                                 setTimeout(function() { location.reload(); }, 2000);
            |                             }
            |                             resolve();
            |                         });
            |                     } else {
            |                         resolve();
            |                     }
            |                 } catch (error) {
            |                     console.error('Error clearing thumbnail:', error);
            |                     resolve();
            |                 }
            |             });
            |         }));
            |     }
            | }
            | 
            | function generateThumbnail(row, videoPath, timeMs, callback) {
            |     const statusDiv = row.querySelector('.status-msg');
            |     statusDiv.classList.remove('is-hidden', 'is-success', 'is-danger');
            |     statusDiv.classList.add('is-info');
            |     statusDiv.innerHTML = '<progress class="progress is-small is-info" value="0" max="100">0%</progress><span>Initializing...</span>';
            |     
            |     const eventSource = new EventSource('/' + secretKey + '/admin/api/generate-thumbnail?videoPath=' + encodeURIComponent(videoPath) + '&timeMs=' + timeMs);
            |     
            |     eventSource.onmessage = function(event) {
            |         const data = JSON.parse(event.data);
            |         
            |         if (data.error) {
            |             eventSource.close();
            |             statusDiv.classList.remove('is-info', 'is-success');
            |             statusDiv.classList.add('is-danger');
            |             statusDiv.innerHTML = 'Error: ' + data.error;
            |             if (callback) callback();
            |             return;
            |         }
            |         
            |         if (data.progress === 100) {
            |             eventSource.close();
            |             statusDiv.classList.remove('is-info', 'is-danger');
            |             statusDiv.classList.add('is-success');
            |             statusDiv.innerHTML = 'Thumbnail generated successfully!';
            |             if (callback) {
            |                 callback();
            |             } else {
            |                 setTimeout(function() { location.reload(); }, 2000);
            |             }
            |             return;
            |         }
            |         
            |         statusDiv.innerHTML = '<progress class="progress is-small is-info" value="' + data.progress + '" max="100">' + data.progress + '%</progress><span>' + data.step + '...</span>';
            |     };
            |     
            |     eventSource.onerror = function(error) {
            |         eventSource.close();
            |         statusDiv.classList.remove('is-info', 'is-success');
            |         statusDiv.classList.add('is-danger');
            |         statusDiv.innerHTML = 'Error: Connection failed';
            |         if (callback) callback();
            |     };
            | }
            | 
            | function clearThumbnail(row, thumbnailPath, callback) {
            |     const statusDiv = row.querySelector('.status-msg');
            |     statusDiv.classList.remove('is-hidden', 'is-success', 'is-danger');
            |     statusDiv.classList.add('is-info');
            |     statusDiv.textContent = 'Clearing thumbnail...';
            |     
            |     fetch('/' + secretKey + '/admin/api/clear-thumbnail', {
            |         method: 'POST',
            |         headers: {'Content-Type': 'application/json'},
            |         body: JSON.stringify({thumbnailPath: thumbnailPath})
            |     })
            |     .then(function(response) { return response.json(); })
            |     .then(function(data) {
            |         statusDiv.classList.remove('is-info', 'is-danger');
            |         statusDiv.classList.add('is-success');
            |         statusDiv.textContent = data.message || 'Thumbnail cleared successfully!';
            |         if (callback) {
            |             callback();
            |         } else {
            |             setTimeout(function() { location.reload(); }, 2000);
            |         }
            |     })
            |     .catch(function(error) {
            |         statusDiv.classList.remove('is-info', 'is-success');
            |         statusDiv.classList.add('is-danger');
            |         statusDiv.textContent = 'Error: ' + error.message;
            |         if (callback) callback();
            |     });
            | }
