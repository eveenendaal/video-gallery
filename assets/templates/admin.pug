doctype html
html
    head
        meta(name="viewport" content="width=device-width,initial-scale=1.0")
        title Admin - Thumbnail Management
        style 
            include ../../public/styles.css
    body
        div.header.hero.is-dark.is-small
            div.hero-head
                div.container.has-text-centered-mobile.block
                    h1.title.is-2 Admin - Thumbnail Management
                    p.subtitle Browse and manage video thumbnails
        div.container
            div.section
                h2.title.is-4 Video Management
                
                div.box.mb-4
                    h3.subtitle.is-5 Filters
                    div.field.is-grouped.is-grouped-multiline
                        div.control
                            label.label.is-small Category
                            div.select.is-small
                                select#filterCategory(onchange="applyFilters()")
                                    option(value="") All Categories
                                    each category in Categories
                                        option #{category.Name}
                        div.control
                            label.label.is-small Gallery
                            div.select.is-small
                                select#filterGallery(onchange="applyFilters()")
                                    option(value="") All Galleries
                        div.control
                            label.label.is-small Status
                            div.select.is-small
                                select#filterStatus(onchange="applyFilters()")
                                    option(value="") All
                                    option(value="has") Has Thumbnail
                                    option(value="missing") Missing Thumbnail
                        div.control
                            label.label.is-small Search
                            input.input.is-small#filterSearch(type="text" placeholder="Search videos..." oninput="applyFilters()")
                
                div.box.mb-4
                    h3.subtitle.is-5 Bulk Operations
                    div.field.is-grouped
                        div.control
                            label.label.is-small Thumbnail Time (ms)
                            input.input.is-small#bulkTimeMs(type="number" value="1000" min="0" step="100")
                        div.control
                            label.label.is-small &nbsp;
                            button.button.is-info.is-small#btnGenerate(onclick="generateSelectedThumbnails()" disabled)
                                span.icon
                                    i üì∑
                                span Generate Selected
                        div.control
                            label.label.is-small &nbsp;
                            button.button.is-danger.is-small#btnClear(onclick="clearSelectedThumbnails()" disabled)
                                span.icon
                                    i üóëÔ∏è
                                span Clear Selected
                        div.control
                            label.label.is-small &nbsp;
                            span.tag.is-info#selectedCount 0 selected
                
                div.table-container
                    table.table.is-fullwidth.is-striped.is-hoverable#videoTable
                        thead
                            tr
                                th
                                    input#selectAll(type="checkbox" onchange="toggleSelectAll()")
                                th Thumbnail
                                th Video
                                th Gallery
                                th Category
                                th Status
                                th Actions
                        tbody
                            each category in Categories
                                each gallery in category.Galleries
                                    each video in gallery.Videos
                                        tr.video-row
                                            td
                                                input.video-checkbox(type="checkbox" onchange="updateSelectedCount()")
                                            td
                                                if video.Thumbnail
                                                    figure.image.is-48x48
                                                        img(src=video.Thumbnail alt=video.Name)
                                                else
                                                    figure.image.is-48x48
                                                        div.has-background-grey-lighter(style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;")
                                                            span ‚ùå
                                            td
                                                strong #{video.Name}
                                                input.video-path(type="hidden" value=video.VideoPath)
                                                input.thumbnail-path(type="hidden" value=video.ThumbnailPath)
                                            td #{gallery.Name}
                                            td #{category.Name}
                                            td
                                                if video.Thumbnail
                                                    span.tag.is-success.is-small Has Thumbnail
                                                else
                                                    span.tag.is-warning.is-small Missing
                                            td
                                                div.field.has-addons
                                                    div.control
                                                        input.input.is-small.time-input(type="number" value="1000" min="0" step="100" style="width:80px")
                                                    div.control
                                                        button.button.is-info.is-small.btn-generate(title="Generate")
                                                            span üì∑
                                                    if video.Thumbnail
                                                        div.control
                                                            button.button.is-danger.is-small.btn-clear(title="Clear")
                                                                span üóëÔ∏è
                                                div.notification.is-hidden.mt-2.is-small.status-msg

        script.
            const secretKey = 'asdf';
            
            document.getElementById('videoTable').addEventListener('click', function(e) {
                const generateBtn = e.target.closest('.btn-generate');
                const clearBtn = e.target.closest('.btn-clear');
                
                if (generateBtn) {
                    const row = generateBtn.closest('tr');
                    const videoPath = row.querySelector('.video-path').value;
                    const timeInput = row.querySelector('.time-input');
                    const timeMs = timeInput.value;
                    generateThumbnail(row, videoPath, timeMs);
                } else if (clearBtn) {
                    const row = clearBtn.closest('tr');
                    const thumbnailPath = row.querySelector('.thumbnail-path').value;
                    clearThumbnail(row, thumbnailPath);
                }
            });
            
            document.getElementById('filterCategory').addEventListener('change', function() {
                const category = this.value;
                const gallerySelect = document.getElementById('filterGallery');
                gallerySelect.innerHTML = '<option value="">All Galleries</option>';
                
                if (category) {
                    const rows = document.querySelectorAll('#videoTable tbody tr');
                    const galleries = new Set();
                    rows.forEach(row => {
                        const catCell = row.cells[4];
                        if (catCell && catCell.textContent === category) {
                            const galCell = row.cells[3];
                            if (galCell) galleries.add(galCell.textContent);
                        }
                    });
                    galleries.forEach(gallery => {
                        const option = document.createElement('option');
                        option.value = gallery;
                        option.textContent = gallery;
                        gallerySelect.appendChild(option);
                    });
                }
            });
            
            function applyFilters() {
                const category = document.getElementById('filterCategory').value;
                const gallery = document.getElementById('filterGallery').value;
                const status = document.getElementById('filterStatus').value;
                const search = document.getElementById('filterSearch').value.toLowerCase();
                
                const rows = document.querySelectorAll('#videoTable tbody tr');
                rows.forEach(row => {
                    let show = true;
                    const thumbnail = row.querySelector('img');
                    const hasThumbnail = thumbnail !== null;
                    const videoName = row.cells[2].textContent.trim();
                    const galleryName = row.cells[3].textContent.trim();
                    const categoryName = row.cells[4].textContent.trim();
                    
                    if (category && categoryName !== category) show = false;
                    if (gallery && galleryName !== gallery) show = false;
                    if (status === 'has' && !hasThumbnail) show = false;
                    if (status === 'missing' && hasThumbnail) show = false;
                    if (search && !videoName.toLowerCase().includes(search)) show = false;
                    
                    row.style.display = show ? '' : 'none';
                });
            }
            
            function toggleSelectAll() {
                const selectAll = document.getElementById('selectAll');
                const checkboxes = document.querySelectorAll('.video-checkbox');
                checkboxes.forEach(cb => {
                    const row = cb.closest('tr');
                    if (row.style.display !== 'none') {
                        cb.checked = selectAll.checked;
                    }
                });
                updateSelectedCount();
            }
            
            function updateSelectedCount() {
                const checked = document.querySelectorAll('.video-checkbox:checked');
                const count = checked.length;
                document.getElementById('selectedCount').textContent = count + ' selected';
                document.getElementById('btnGenerate').disabled = count === 0;
                document.getElementById('btnClear').disabled = count === 0;
            }
            
            function generateSelectedThumbnails() {
                const timeMs = document.getElementById('bulkTimeMs').value;
                const checked = document.querySelectorAll('.video-checkbox:checked');
                
                if (checked.length === 0) return;
                
                if (!confirm('Generate thumbnails for ' + checked.length + ' video(s)?')) return;
                
                checked.forEach(cb => {
                    const row = cb.closest('tr');
                    const videoPath = row.querySelector('.video-path').value;
                    generateThumbnail(row, videoPath, timeMs);
                });
            }
            
            function clearSelectedThumbnails() {
                const checked = document.querySelectorAll('.video-checkbox:checked');
                
                if (checked.length === 0) return;
                
                if (!confirm('Clear thumbnails for ' + checked.length + ' video(s)? This cannot be undone.')) return;
                
                checked.forEach(cb => {
                    const row = cb.closest('tr');
                    const thumbnailPath = row.querySelector('.thumbnail-path').value;
                    if (thumbnailPath) {
                        clearThumbnail(row, thumbnailPath);
                    }
                });
            }
            
            function generateThumbnail(row, videoPath, timeMs) {
                const statusDiv = row.querySelector('.status-msg');
                statusDiv.classList.remove('is-hidden', 'is-success', 'is-danger');
                statusDiv.classList.add('is-info');
                statusDiv.innerHTML = '<progress class="progress is-small is-info" value="0" max="100">0%</progress><span>Initializing...</span>';
                
                const eventSource = new EventSource('/' + secretKey + '/admin/api/generate-thumbnail?videoPath=' + encodeURIComponent(videoPath) + '&timeMs=' + timeMs);
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.error) {
                        eventSource.close();
                        statusDiv.classList.remove('is-info', 'is-success');
                        statusDiv.classList.add('is-danger');
                        statusDiv.innerHTML = 'Error: ' + data.error;
                        return;
                    }
                    
                    if (data.progress === 100) {
                        eventSource.close();
                        statusDiv.classList.remove('is-info', 'is-danger');
                        statusDiv.classList.add('is-success');
                        statusDiv.innerHTML = 'Thumbnail generated successfully!';
                        setTimeout(function() { location.reload(); }, 2000);
                        return;
                    }
                    
                    statusDiv.innerHTML = '<progress class="progress is-small is-info" value="' + data.progress + '" max="100">' + data.progress + '%</progress><span>' + data.step + '...</span>';
                };
                
                eventSource.onerror = function(error) {
                    eventSource.close();
                    statusDiv.classList.remove('is-info', 'is-success');
                    statusDiv.classList.add('is-danger');
                    statusDiv.innerHTML = 'Error: Connection failed';
                };
            }
            
            function clearThumbnail(row, thumbnailPath) {
                const statusDiv = row.querySelector('.status-msg');
                statusDiv.classList.remove('is-hidden', 'is-success', 'is-danger');
                statusDiv.classList.add('is-info');
                statusDiv.textContent = 'Clearing thumbnail...';
                
                fetch('/' + secretKey + '/admin/api/clear-thumbnail', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({thumbnailPath: thumbnailPath})
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    statusDiv.classList.remove('is-info', 'is-danger');
                    statusDiv.classList.add('is-success');
                    statusDiv.textContent = data.message || 'Thumbnail cleared successfully!';
                    setTimeout(function() { location.reload(); }, 2000);
                })
                .catch(function(error) {
                    statusDiv.classList.remove('is-info', 'is-success');
                    statusDiv.classList.add('is-danger');
                    statusDiv.textContent = 'Error: ' + error.message;
                });
            }
